C51 COMPILER V9.60.7.0   MAIN                                                              08/30/2023 14:52:08 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\赛元8003应用资料\SC92F8003 DEM
                    -O CODE\SC92F8003_Lib\inc) DEBUG OBJECTEXTEND PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          
   2          #include "sc92f8003_gpio.h"
   3          
   4          
   5          #define   DQ_PIN  GPIO_PIN_4
   6          #define   DQ_OUT  GPIO_Init(GPIO1,DQ_PIN,GPIO_MODE_OUT_PP)
   7          #define   DQ_IN   GPIO_Init(GPIO1,DQ_PIN,GPIO_MODE_IN_PU)
   8          #define   DQ_DE   GPIO_DeInit()
   9          
  10          #define tRSTL 480//-
  11          #define tRSTH 480//-
  12          #define tPDH  15//-60
  13          #define tPDL  60//-240
  14          
  15          #define tSLOT 60//60-120
  16          #define tLOW1 15//1-15
  17          #define tREC  1//1-
  18          #define tLOW0 60//60-120<tSLOT
  19          
  20          #define tRELEASE  0//0-45
  21          #define tLOWR   1//1-15
  22          #define tRDV  15
  23          #define tSU   1//<1
  24          
  25          static void delay_us(uint32_t us)
  26          {
  27   1      #if 1  /* 不用系统延时时开启这个！！*/
  28   1          volatile int32_t i;
  29   1        
  30   1          for (; us > 0; us--)
  31   1          {
  32   2              i = 100;  //mini 17
  33   2              while(i--);
  34   2          }
  35   1      #else
                  Delayus(us);
              #endif
  38   1      }
  39          
  40            
  41          void ACT_INIT(void)
  42          {
  43   1        GPIO_Init(GPIO1,DQ_PIN,GPIO_MODE_OUT_PP);
  44   1        delay_us(tPDH);
  45   1        GPIO_WriteLow(GPIO1,DQ_PIN);
  46   1        delay_us(tPDL);
  47   1        delay_us(tPDL);
  48   1        GPIO_WriteHigh(GPIO1,DQ_PIN);
  49   1      }
  50          
  51          
  52          void WRITE_BYTES(const unsigned char * src, unsigned char len){
  53   1        unsigned char i = 0;
  54   1        char value;
C51 COMPILER V9.60.7.0   MAIN                                                              08/30/2023 14:52:08 PAGE 2   

  55   1        
  56   1          DQ_IN;
  57   1          while(len>0){
  58   2              value=*src;
  59   2          for(i=0;i<8;i++){
  60   3      
  61   3            while( GPIO_ReadPin(GPIO1,DQ_PIN) == 1 );
  62   3            
  63   3            DQ_OUT;
  64   3            if (value & 0x1)
  65   3              GPIO_WriteHigh(GPIO1,DQ_PIN);
  66   3            else
  67   3              GPIO_WriteLow(GPIO1,DQ_PIN);
  68   3            
  69   3            value>>=1;
  70   3                  
  71   3            delay_us(tRDV);//max tLOWR
  72   3            delay_us(tRDV);//
  73   3            
  74   3            GPIO_WriteHigh(GPIO1,DQ_PIN);
  75   3                  
  76   3            DQ_IN;
  77   3            if( GPIO_ReadPin(GPIO1,DQ_PIN) == 0 ){
  78   4              while( GPIO_ReadPin(GPIO1,DQ_PIN) == 0 );
  79   4                      ACT_INIT();
  80   4              return;
  81   4            }
  82   3          }
  83   2              src++;
  84   2              len--;
  85   2          }
  86   1      }
  87          
  88          
  89          
  90          void main(void)
  91          {
  92   1        unsigned int i = 0;
  93   1        unsigned int lowTime;
  94   1        unsigned char cmd = 0, Count = 0;
  95   1        unsigned char datas[10] = { 0 };  
  96   1        BitStatus ret = 0;
  97   1        
  98   1        GPIO_Init(GPIO1,GPIO_PIN_3,GPIO_MODE_OUT_PP);
  99   1        
 100   1        while (1)
 101   1        {
 102   2                  DQ_IN;
 103   2          while (1)
 104   2          {
 105   3            ret = GPIO_ReadPin(GPIO1,DQ_PIN);
 106   3            if (ret != 1) 
 107   3            {
 108   4      //        GPIO_WriteHigh(GPIO1,GPIO_PIN_3);
 109   4              break;
 110   4            }
 111   3          }
 112   2      //      while( GPIO_ReadPin(GPIO1,DQ_PIN) == 1 );
 113   2            
 114   2          lowTime = 0;
 115   2          while (1)
 116   2          {
C51 COMPILER V9.60.7.0   MAIN                                                              08/30/2023 14:52:08 PAGE 3   

 117   3            ret = GPIO_ReadPin(GPIO1, DQ_PIN);
 118   3            if (ret != 0)
 119   3            {
 120   4      //        GPIO_WriteLow(GPIO1,GPIO_PIN_3); 
 121   4              break;
 122   4            }
 123   3            lowTime++;
 124   3            delay_us(1);
 125   3          }
 126   2          /*
 127   2            lowTime = 0;
 128   2            while( GPIO_ReadPin(GPIO1,DQ_PIN) == 0 ){
 129   2            lowTime++;
 130   2            delay_us(1);
 131   2          }
 132   2          */
 133   2          
 134   2            if( lowTime > tRSTL )
 135   2            {
 136   3              Count = 0;
 137   3      //        GPIO_WriteHigh(GPIO1,GPIO_PIN_3);
 138   3              ACT_INIT();
 139   3      //        GPIO_WriteLow(GPIO1,GPIO_PIN_3); 
 140   3              continue;
 141   3            }
 142   2            
 143   2            Count++;
 144   2            cmd>>=1;
 145   2            if( lowTime < tLOW1 ){
 146   3              cmd |= 0x80 ;
 147   3              GPIO_WriteHigh(GPIO1,GPIO_PIN_3);
 148   3            }
 149   2            else if (lowTime > tLOW0)
 150   2            {
 151   3              GPIO_WriteLow(GPIO1,GPIO_PIN_3); 
 152   3            }
 153   2      
 154   2          if( Count == 8 )
 155   2          {
 156   3            Count = 0;
 157   3            datas[i] = cmd;
 158   3            i++;
 159   3            if (i >= 10) i = 0;
 160   3            /*
 161   3            if (cmd == 0x10)
 162   3            {
 163   3              delay_us(100);
 164   3              GPIO_WriteHigh(GPIO1,GPIO_PIN_3);
 165   3              delay_us(100);
 166   3              GPIO_WriteLow(GPIO1,GPIO_PIN_3); 
 167   3            }
 168   3            */
 169   3            cmd = 0x00;
 170   3            /*
 171   3            if( cmd == datas[0] ){
 172   3              WRITE_BYTES( datas + 1, 8 );
 173   3            }
 174   3            */
 175   3          }
 176   2      
 177   2        }
 178   1        
C51 COMPILER V9.60.7.0   MAIN                                                              08/30/2023 14:52:08 PAGE 4   

 179   1        /*
 180   1        uint16_t i,j;
 181   1        
 182   1        GPIO_Init(GPIO1,DQ_PIN,GPIO_MODE_OUT_PP); //将P14设置为强推挽输出
 183   1      
 184   1        while(1)
 185   1        {
 186   1          GPIO_WriteHigh(GPIO1,DQ_PIN);     //P14写高
 187   1          for(i=0;i<600 * 1;i++)              //延时一段时间
 188   1          {
 189   1            for(j=0;j<300;j++);
 190   1          }
 191   1          GPIO_WriteLow(GPIO1,DQ_PIN);      //P14写低
 192   1          for(i=0;i<600 * 1;i++)              //延时一段时间
 193   1          {
 194   1            for(j=0;j<300;j++);
 195   1          }
 196   1        }
 197   1        */
 198   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    490    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      31
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
